app-id: app.bluebubbles.BlueBubbles
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: bluebubbles
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.NetworkManager
  - --system-talk-name=org.freedesktop.NetworkManager.Connection.Active
  - --system-talk-name=org.freedesktop.FileManager1
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=NOTIFY_IGNORE_PORTAL=1
  - --share=network
  - --filesystem=home
modules:
  - 'shared-modules/libappindicator/libappindicator-gtk3-12.10.json'
  - 'shared-modules/dbus-glib/dbus-glib.json'
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dtests=false
      - -Dintrospection=disabled
      - -Dman=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.8/libnotify-0.8.3.tar.xz
        sha256: ee8f3ef946156ad3406fdf45feedbdcd932dbd211ab4f16f75eba4f36fb2f6c0
        x-checker-data:
          type: gnome
          name: libnotify
          stable-only: true
  - name: zenity
    buildsystem: meson
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/zenity.git
        tag: 3.43.0
        commit: 01e6d92f23f49414ba8ec4c5b3daf49222c1e31d
    cleanup:
      - /share/*
      - /bin/gdialog
  - name: xorg-libXmu
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxmu.git
        tag: libXmu-1.2.1
        commit: 792f80402ee06ce69bca3a8f2a84295999c3a170
  - name: wmctrl
    sources:
      - type: git
        url: https://github.com/dancor/wmctrl.git
        commit: 0181e8e4a7ed98255f6ef930875e56560f19aa95
    cleanup:
      - /share/man
  - name: objectbox
    buildsystem: simple
    build-commands:
      - 'cp -r libobjectbox.so /app/lib/'
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/objectbox/objectbox-c/releases/download/v4.0.2/objectbox-linux-x64.tar.gz
        sha256: 2cbf4fcacfed056b1b223db3fdfd5dbcf1c71d6eb349a914c07261e54c4d3c92
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/objectbox/objectbox-c/releases/download/v4.0.2/objectbox-linux-aarch64.tar.gz
        sha256: ff8babb59423312c5f6cee58533c9e20a3970c2c0f7eb9082ef220a93cd8ce5f
  - name: libidn
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/libidn/libidn-1.42.tar.gz
        sha256: d6c199dcd806e4fe279360cb4b08349a0d39560ed548ffd1ccadda8cdecb4723
    cleanup:
      - /bin/*
      - /include/*
      - /share/*
  - name: libmpv
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=false
      - -Dalsa=disabled
      - -Dmanpage-build=disabled
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.39.0
        commit: a0fba7be57f3822d967b04f0f6b6d6341e7516e7
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
    modules:
      - name: nv-codec-headers
        no-autogen: true
        make-install-args:
          - 'PREFIX=/app'
        sources:
          - type: git
            url: https://github.com/FFmpeg/nv-codec-headers.git
            tag: n12.2.72.0
            commit: c69278340ab1d5559c7d7bf0edf615dc33ddbba7
        cleanup:
          - '*'
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.3/libass-0.17.3.tar.xz
            sha256: eae425da50f0015c21f7b3a9c7262a910f0218af469e22e2931462fed3c50959
      - name: ffmpeg
        sources:
          - type: archive
            url: https://ffmpeg.org/releases/ffmpeg-6.1.2.tar.xz
            sha256: 3b624649725ecdc565c903ca6643d41f33bd49239922e45c9b1442c63dca4e38
      - name: libplacebo  # Almost entirely copied from https://github.com/flathub/io.github.KikoPlayProject.KikoPlay/blob/master/io.github.KikoPlayProject.KikoPlay.yaml#L37
        buildsystem: meson
        config-opts:
          - -Dshaderc=enabled
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=false
        sources:
          - type: git
            url: https://code.videolan.org/videolan/libplacebo.git
            tag: v7.349.0
            commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
        modules:
          - name: shaderc
            buildsystem: cmake-ninja
            builddir: true
            config-opts:
              - -DSHADERC_SKIP_COPYRIGHT_CHECK=ON
              - -DSHADERC_SKIP_EXAMPLES=ON
              - -DSHADERC_SKIP_TESTS=ON
              - -DSPIRV_SKIP_EXECUTABLES=ON
              - -DENABLE_GLSLANG_BINARIES=OFF
            cleanup:
              - /bin
              - /include
              - /lib/cmake
              - /lib/pkgconfig
            sources:
              - type: git
                url: https://github.com/google/shaderc.git
                tag: v2024.3
                commit: ff84893dd52d28f0b1737d2635733d952013bd9c
                x-checker-data:
                  type: git
                  tag-pattern: ^v(\d{4}\.\d{1,2})$
              - type: archive
                url: https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/sdk-1.3.261.1.tar.gz
                sha256: ead95c626ad482882a141d1aa0ce47b9453871f72c42c0b28d39c82f60a52008
                dest: third_party/spirv-tools
                x-checker-data:
                  type: anitya
                  stable-only: true
                  project-id: 334920
                  url-template: https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/sdk-$version.tar.gz
              - type: archive
                url: https://github.com/KhronosGroup/SPIRV-Headers/archive/refs/tags/sdk-1.3.261.1.tar.gz
                sha256: 32b4c6ae6a2fa9b56c2c17233c8056da47e331f76e117729925825ea3e77a739
                dest: third_party/spirv-headers
                x-checker-data:
                  type: anitya
                  stable-only: true
                  project-id: 334920
                  url-template: https://github.com/KhronosGroup/SPIRV-Headers/archive/refs/tags/sdk-$version.tar.gz
              - type: git
                url: https://github.com/KhronosGroup/glslang.git
                tag: 15.0.0
                commit: 46ef757e048e760b46601e6e77ae0cb72c97bd2f
                dest: third_party/glslang
                x-checker-data:
                  type: git
                  tag-pattern: ^(\d{1,2}\.\d{1,2}\.\d{1,4})$
  - name: fmedia
    buildsystem: simple
    only_arches:
      - x86_64
    build-commands:
      - 'mkdir -p /app/bin'
      - 'cp -r fmedia-1 /app/bin'
      - 'ln -s /app/bin/fmedia-1/fmedia /app/bin/fmedia'
    sources:
      - type: archive
        dest: fmedia-1
        url: https://github.com/stsaz/fmedia/releases/download/v1.31/fmedia-1.31-linux-amd64.tar.xz
        sha256: 9f2347b0316275b081e98feaaed8b17c4750c2855f85606b79b26f6e62ba8ab0
  - name: arp
    buildsystem: simple
    build-commands:
      - 'yes "" | make arp'
      - 'install -Dm755 arp /app/bin/arp'
    sources:
      - type: git
        url: https://github.com/ecki/net-tools.git
        tag: v2.10
        commit: 80d7b95067f1f22fece9537dea6dff53081f4886
  - name: webkit2gtk-4.1  # Almost entirely copied from https://github.com/flathub/org.geany.Geany/blob/master/webkitgtk.yml
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DPORT=GTK
      - -DUSE_GTK4=OFF
      - -DUSE_LIBSECRET=OFF
      - -DUSE_LIBBACKTRACE=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
      - -DENABLE_DOCUMENTATION=OFF
      - -DENABLE_MINIBROWSER=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.44.2.tar.xz
        sha256: 523f42c8ff24832add17631f6eaafe8f9303afe316ef1a7e1844b952a7f7521b
        x-checker-data:
          type: html
          url: https://webkitgtk.org/releases/
          version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
          url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
      - type: shell
        commands:
          - sed -i 's@NAMES avif.h@NAMES avif/avif.h@' Source/cmake/FindAVIF.cmake
          - sed -i '/PATH_SUFFIXES avif/d' Source/cmake/FindAVIF.cmake
          - sed -i 's@${AVIF_INCLUDE_DIR}/avif.h@${AVIF_INCLUDE_DIR}/avif/avif.h@' Source/cmake/FindAVIF.cmake
    modules:
      - name: unifdef
        no-autogen: true
        make-install-args:
          - prefix=${FLATPAK_DEST}
        sources:
          - type: archive
            url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
            sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
            x-checker-data:
              type: anitya
              project-id: 5046
              url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
        cleanup:
          - '*'
      - name: highway
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE=RelWithDebInfo
          - -DBUILD_SHARED_LIBS=ON
          - -DBUILD_TESTING=OFF
          - -DHWY_ENABLE_CONTRIB=OFF
          - -DHWY_ENABLE_EXAMPLES=OFF
        sources:
          - type: archive
            url: https://github.com/google/highway/archive/1.2.0/highway-1.222.0.tar.gz
            sha256: 7e0be78b8318e8bdbf6fa545d2ecb4c90f947df03f7aadc42c1967f019e63343
            x-checker-data:
              type: json
              url: https://api.github.com/repos/google/highway/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag
              url-query: '"https://github.com/google/highway/archive/\($tag)/highway-\($version).tar.gz"'
      - name: woff2
        buildsystem: cmake-ninja
        builddir: true
        sources:
          - type: archive
            url: https://github.com/google/woff2/archive/v1.0.2.tar.gz
            sha256: add272bb09e6384a4833ffca4896350fdb16e0ca22df68c0384773c67a175594
            x-checker-data:
              type: anitya
              project-id: 17587
              url-template: https://github.com/google/woff2/archive/v$version.tar.gz
      - name: libavif
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE=RelWithDebInfo
          - -DAVIF_CODEC_DAV1D=SYSTEM
          - -DAVIF_LIBYUV=OFF
          - -DBUILD_SHARED_LIBS=ON
        sources:
          - type: archive
            url: https://github.com/AOMediaCodec/libavif/archive/v1.1.1/libavif-1.1.1.tar.gz
            sha256: 914662e16245e062ed73f90112fbb4548241300843a7772d8d441bb6859de45b
            x-checker-data:
              type: json
              url: https://api.github.com/repos/AOMediaCodec/libavif/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag | sub("^[vV]"; "")
              url-query: '"https://github.com/AOMediaCodec/libavif/archive/\($tag)/libavif-\($version).tar.gz"'
      - name: libjxl
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCMAKE_BUILD_TYPE=RelWithDebInfo
          - -DBUILD_TESTING=OFF
          - -DJPEGXL_ENABLE_DEVTOOLS=OFF
          - -DJPEGXL_ENABLE_TOOLS=OFF
          - -DJPEGXL_ENABLE_DOXYGEN=OFF
          - -DJPEGXL_ENABLE_MANPAGES=OFF
          - -DJPEGXL_ENABLE_BENCHMARK=OFF
          - -DJPEGXL_ENABLE_EXAMPLES=OFF
          - -DJPEGXL_ENABLE_JNI=OFF
          - -DJPEGXL_ENABLE_SJPEG=OFF
          - -DJPEGXL_ENABLE_OPENEXR=OFF
          - -DJPEGXL_ENABLE_SKCMS=OFF
          - -DJPEGXL_FORCE_SYSTEM_BROTLI=ON
          - -DJPEGXL_FORCE_SYSTEM_LCMS2=ON
          - -DJPEGXL_FORCE_SYSTEM_HWY=ON
        post-install:
          # It doesn't respect disabling static libraries...
          - rm $FLATPAK_DEST/lib/*.a
        sources:
          - type: archive
            url: https://github.com/libjxl/libjxl/archive/v0.11.0/libjxl-0.11.0.tar.gz
            sha256: 7ce4ec8bb37a435a73ac18c4c9ff56c2dc6c98892bf3f53a328e3eca42efb9cf
            x-checker-data:
              type: json
              url: https://api.github.com/repos/libjxl/libjxl/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag | sub("^[vV]"; "")
              url-query: '"https://github.com/libjxl/libjxl/archive/\($tag)/libjxl-\($version).tar.gz"'
      - name: libwpe
        buildsystem: meson
        builddir: true
        config-opts:
          - --buildtype=plain
        sources:
          - type: archive
            url: https://github.com/WebPlatformForEmbedded/libwpe/releases/download/1.16.0/libwpe-1.16.0.tar.xz
            sha256: c7f3a3c6b3d006790d486dc7cceda2b6d2e329de07f33bc47dfc53f00f334b2a
            x-checker-data:
              type: json
              url: https://api.github.com/repos/WebPlatformForEmbedded/libwpe/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag
              url-query: '"https://github.com/WebPlatformForEmbedded/libwpe/releases/download/\($tag)/libwpe-\    ($version).tar.xz"'
      - name: wpebackend-fdo
        buildsystem: meson
        builddir: true
        config-opts:
          - --buildtype=plain
        sources:
          - type: archive
            url: https://github.com/Igalia/WPEBackend-fdo/releases/download/1.14.3/wpebackend-fdo-1.14.3.tar.xz
            sha256: 10121842595a850291db3e82f3db0b9984df079022d386ce42c2b8508159dc6c
            x-checker-data:
              type: json
              url: https://api.github.com/repos/Igalia/WPEBackend-fdo/releases/latest
              tag-query: .tag_name
              timestamp-query: .published_at
              version-query: $tag
              url-query: '"https://github.com/Igalia/WPEBackend-fdo/releases/download/\($tag)/wpebackend-fdo-\    ($version).tar.xz"'
  - name: bluebubbles
    buildsystem: simple
    build-commands:
      - 'cp -r bluebubbles /app/'
      - 'mkdir -p /app/bin'
      - 'ln -s /app/bluebubbles/bluebubbles /app/bin/bluebubbles'
      - 'install -Dm644 app.bluebubbles.BlueBubbles.metainfo.xml -t /app/share/metainfo/'
      - 'install -Dm644 128x128.png /app/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png'
      - 'install -Dm644 app.bluebubbles.BlueBubbles.desktop -t /app/share/applications/'
    sources:
      - type: archive
        only_arches:
          - x86_64
        dest: bluebubbles
        url: https://github.com/BlueBubblesApp/bluebubbles-app/releases/download/v1.14.0%2B67-b.1/bluebubbles-linux-x86_64.tar
        sha256: 23d3983188c7a0e1ab4625f98711700fb010c00d10155d8f8a904942eb1ff730
      - type: archive
        only_arches:
          - aarch64
        dest: bluebubbles
        url: https://github.com/BlueBubblesApp/bluebubbles-app/releases/download/v1.14.0%2B67-b.1/bluebubbles-linux-aarch64.tar
        sha256: 21d2258ae120c20f0b6d093476bdab63b88133edf72c5333a8351be12ca48053
      - type: file
        path: app.bluebubbles.BlueBubbles.metainfo.xml
      - type: file
        path: icons/128x128.png
      - type: file
        path: app.bluebubbles.BlueBubbles.desktop
    cleanup:
      - /bluebubbles/data/flutter_assets/packages/wakelock_web
      - /bluebubbles/data/flutter_assets/packages/flutter_dropzone_web
      - /bluebubbles/data/flutter_assets/packages/libphonenumber_plugin
  - name: pdfium
    buildsystem: simple
    build-commands:
      - mv libpdfium/libpdfium.so /app/bluebubbles/lib
    sources:
      - type: archive
        only_arches:
          - x86_64
        url: https://github.com/bblanchon/pdfium-binaries/releases/download/chromium%2F6721/pdfium-linux-x64.tgz
        sha256: 8783e0e46d846125227b7735d5625c2844a25ff315c0bf60a2834d457622b921
        dest: libpdfium
      - type: archive
        only_arches:
          - aarch64
        url: https://github.com/bblanchon/pdfium-binaries/releases/download/chromium%2F6721/pdfium-linux-arm64.tgz
        sha256: a0098cf9a945ef4e3b1ea7c777707e9c53d8c3c1918893a72cf1fc6c3e919c14
        dest: libpdfium
    cleanup:
      - /libpdfium

